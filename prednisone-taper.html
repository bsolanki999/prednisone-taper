<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prednisone Taper</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    :root {
      --bg-dark: #0d1117;
      --bg-card: #161b22;
      --bg-input: #21262d;
      --border: #30363d;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --accent: #00b4d8;
      --accent-glow: rgba(0, 180, 216, 0.3);
      --success: #3fb950;
      --warning: #d29922;
      --danger: #f85149;
    }
    
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-dark);
      background-image: radial-gradient(ellipse at top, #1a2332 0%, var(--bg-dark) 60%);
      min-height: 100vh; 
      padding: 40px 20px;
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
    }
    
    .container { max-width: 600px; margin: 0 auto; }
    
    .header {
      text-align: center;
      margin-bottom: 40px;
    }
    
    h1 { 
      font-size: 42px; 
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -1px;
      margin-bottom: 8px;
    }
    
    .subtitle { 
      color: var(--text-secondary); 
      font-size: 18px; 
      font-weight: 400;
    }
    
    .card { 
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px; 
      padding: 28px;
      margin-bottom: 20px;
    }
    
    .section-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 14px;
    }
    
    .quantity-input {
      position: relative;
    }
    
    .quantity-input input {
      width: 100%;
      padding: 18px 20px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 20px;
      font-weight: 500;
      font-family: inherit;
      outline: none;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }
    
    .quantity-input input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
    }
    
    .quantity-input input::placeholder { color: var(--text-secondary); }
    
    .quantity-input .spinner {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .quantity-input .spinner button {
      width: 28px;
      height: 20px;
      border: none;
      background: var(--bg-dark);
      color: var(--text-secondary);
      border-radius: 4px;
      cursor: pointer;
      font-size: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .quantity-input .spinner button:hover {
      background: var(--border);
      color: var(--text-primary);
    }
    
    .dose-header {
      display: grid;
      grid-template-columns: 1fr 1fr 100px;
      gap: 16px;
      margin-bottom: 12px;
      padding: 0 8px;
    }
    
    .dose-header span {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .dose-header span:last-child {
      text-align: right;
      justify-content: flex-end;
    }
    
    .dose-row {
      display: grid;
      grid-template-columns: 1fr 1fr 100px;
      gap: 16px;
      margin-bottom: 10px;
      align-items: center;
    }
    
    .stepper {
      display: flex;
      align-items: center;
      background: var(--bg-input);
      border: 2px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }
    
    .stepper button {
      width: 44px;
      height: 52px;
      border: none;
      background: transparent;
      color: var(--accent);
      font-size: 24px;
      font-weight: 300;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .stepper button:hover {
      background: var(--bg-dark);
    }
    
    .stepper button:active {
      background: var(--border);
    }
    
    .stepper input {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-size: 20px;
      font-weight: 600;
      text-align: center;
      font-family: inherit;
      outline: none;
      padding: 14px 0;
      min-width: 0;
    }
    
    .stepper input::placeholder { color: var(--text-secondary); }
    
    .stepper:focus-within {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
    }
    
    .total-tabs {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent);
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    
    .add-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: transparent;
      border: 2px dashed var(--border);
      border-radius: 12px;
      color: var(--text-secondary);
      font-weight: 500;
      cursor: pointer;
      font-size: 16px;
      font-family: inherit;
      padding: 16px;
      width: 100%;
      margin-top: 16px;
      transition: all 0.2s;
    }
    
    .add-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(0, 180, 216, 0.05);
    }
    
    .results-card {
      border-radius: 16px;
      padding: 28px;
      text-align: center;
      border: 2px solid;
    }
    
    .results-card.match { 
      background: rgba(63, 185, 80, 0.1);
      border-color: var(--success);
    }
    .results-card.mismatch { 
      background: rgba(210, 153, 34, 0.1);
      border-color: var(--warning);
    }
    .results-card.calculated { 
      background: rgba(0, 180, 216, 0.1);
      border-color: var(--accent);
    }
    
    .results-card .status {
      font-size: 14px;
      font-weight: 700;
      letter-spacing: 2px;
      text-transform: uppercase;
      margin-bottom: 20px;
    }
    
    .results-card.match .status { color: var(--success); }
    .results-card.mismatch .status { color: var(--warning); }
    .results-card.calculated .status { color: var(--accent); }
    
    .results-card .grid {
      display: flex;
      justify-content: center;
      gap: 48px;
    }
    
    .results-card .val {
      font-size: 48px;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1;
    }
    
    .results-card .lbl {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-top: 8px;
      font-weight: 600;
    }
    
    .results-card .diff {
      margin-top: 20px;
      font-weight: 700;
      font-size: 16px;
      padding: 8px 20px;
      border-radius: 20px;
      display: inline-block;
    }
    
    .results-card.match .diff { color: var(--success); background: rgba(63, 185, 80, 0.15); }
    .results-card.mismatch .diff { color: var(--danger); background: rgba(248, 81, 73, 0.15); }
    
    .calendar-section-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .calendar-header-section {
      display: flex;
      gap: 14px;
    }
    
    .calendar-header-section input {
      flex: 1;
      padding: 18px 20px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-size: 20px;
      font-weight: 500;
      font-family: inherit;
      outline: none;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: all 0.2s ease;
    }
    
    .calendar-header-section input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
    }
    
    .calendar-header-section input::placeholder { color: var(--text-secondary); }
    
    .btn {
      padding: 18px 32px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      font-size: 16px;
      font-family: inherit;
      transition: all 0.2s ease;
    }
    
    .btn-primary {
      background: var(--accent);
      color: #000;
    }
    
    .btn-primary:hover {
      background: #00a0c4;
      box-shadow: 0 0 20px var(--accent-glow);
    }
    
    .btn-secondary {
      background: var(--bg-input);
      color: var(--text-primary);
      border: 2px solid var(--border);
    }
    
    .btn-secondary:hover {
      border-color: var(--text-secondary);
    }
    
    .calendar-display { padding: 28px; }
    
    .calendar-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 28px;
    }
    
    .calendar-toolbar h2 {
      font-size: 24px;
      font-weight: 600;
    }
    
    .btn-group { display: flex; gap: 12px; }
    
    .month-container {
      page-break-inside: avoid;
      break-inside: avoid;
      margin-bottom: 36px;
    }
    
    .month-title {
      font-size: 22px;
      font-weight: 700;
      margin-bottom: 16px;
      color: var(--text-primary);
    }
    
    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }
    
    .cal-header {
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      padding: 10px 0;
      text-transform: uppercase;
    }
    
    .cal-day {
      aspect-ratio: 1;
      min-height: 68px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg-input);
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    
    .cal-day.empty { background: transparent; border-color: transparent; }
    
    .cal-day.has-dose {
      background: var(--accent);
      border-color: var(--accent);
    }
    
    .cal-day .day-num {
      font-size: 12px;
      color: var(--text-secondary);
      font-weight: 500;
    }
    
    .cal-day.has-dose .day-num { color: rgba(0,0,0,0.6); }
    
    .cal-day .tabs {
      font-size: 24px;
      font-weight: 700;
      color: #000;
      margin-top: 2px;
    }
    
    .instructions {
      margin-top: 24px;
      padding: 20px;
      background: rgba(210, 153, 34, 0.1);
      border: 1px solid var(--warning);
      border-radius: 12px;
      font-size: 15px;
      color: var(--warning);
      line-height: 1.5;
    }
    
    #calendarDisplay { display: none; }
    
    .print-title { display: none; }
    
    @media print {
      body { background: white !important; color: #000 !important; padding: 10px; }
      .no-print { display: none !important; }
      #calendarDisplay { display: block !important; }
      .card { box-shadow: none; border: 1px solid #ddd; background: white; }
      .print-title { display: block !important; text-align: center; margin-bottom: 24px; }
      .print-title h1 { font-size: 28px; color: #000; }
      .print-title p { color: #666; font-size: 15px; margin-top: 4px; }
      .month-container { page-break-inside: avoid; break-inside: avoid; page-break-after: always; }
      .month-container:last-child { page-break-after: avoid; }
      .month-title { color: #000; }
      .cal-day { background: #f5f5f5 !important; border-color: #ddd !important; }
      .cal-day .day-num { color: #666 !important; }
      .cal-day.has-dose { background: #007AFF !important; }
      .cal-day.has-dose .day-num { color: rgba(255,255,255,0.8) !important; }
      .cal-day .tabs { color: white !important; }
      .instructions { background: #fff9e6; border-color: #e6c200; color: #856d00; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header no-print">
      <h1>Prednisone Taper</h1>
      <p class="subtitle">Calculator & Calendar</p>
    </div>
    
    <div class="card no-print">
      <div class="section-label">Quantity Prescribed</div>
      <div class="quantity-input">
        <input type="number" id="quantity" placeholder="Enter quantity (optional)" tabindex="1">
        <div class="spinner">
          <button tabindex="-1" onclick="adjustQuantity(1)">â–²</button>
          <button tabindex="-1" onclick="adjustQuantity(-1)">â–¼</button>
        </div>
      </div>
    </div>
    
    <div class="card no-print">
      <div class="section-label">Dosing Schedule</div>
      <div class="dose-header">
        <span>ðŸ’Š Tabs/day</span>
        <span>ðŸ“… Days</span>
        <span>Total Tabs</span>
      </div>
      <div id="doseLines"></div>
      <button class="add-btn" tabindex="-1" onclick="addLine()">+ Add Line</button>
    </div>
    
    <div id="results" class="no-print"></div>
    
    <div class="card no-print" id="calendarSection" style="display:none;">
      <div class="calendar-section-title">ðŸ“… Generate Calendar</div>
      <div class="calendar-header-section">
        <input type="text" id="startDate" placeholder="MM/DD/YY" maxlength="8" oninput="formatDateInput(this)">
        <button class="btn btn-primary" onclick="generateCalendar()">Generate</button>
      </div>
    </div>
    
    <div class="card" id="calendarDisplay">
      <div class="calendar-display">
        <div class="calendar-toolbar no-print">
          <h2>Schedule</h2>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="window.print()">Print</button>
            <button class="btn btn-primary" onclick="saveAsPDF()">Save PDF</button>
          </div>
        </div>
        
        <div class="print-title">
          <h1>Prednisone Taper Schedule</h1>
          <p id="printSubtitle"></p>
        </div>
        
        <div id="calendarContent"></div>
        
        <div class="instructions">
          <strong>Instructions:</strong> Take the prescribed number of tablets each day as shown. Do not skip doses or stop without consulting your healthcare provider.
        </div>
      </div>
    </div>
  </div>

  <script>
    let doseData = [{tabs:'',days:''},{tabs:'',days:''},{tabs:'',days:''},{tabs:'',days:''},{tabs:'',days:''},{tabs:'',days:''}];
    const weekDays = ['S','M','T','W','T','F','S'];
    
    function formatDateInput(input, e) {
      let value = input.value;
      
      // Get only digits
      let digits = value.replace(/\D/g, '');
      
      // Rebuild with slashes
      let formatted = '';
      if (digits.length > 0) {
        formatted = digits.slice(0, 2);
      }
      if (digits.length > 2) {
        formatted += '/' + digits.slice(2, 4);
      }
      if (digits.length > 4) {
        formatted += '/' + digits.slice(4, 6);
      }
      
      input.value = formatted;
    }
    
    function parseDate(dateStr) {
      if (!dateStr || dateStr.length < 8) return null;
      const parts = dateStr.split('/');
      if (parts.length !== 3) return null;
      const month = parseInt(parts[0]) - 1;
      const day = parseInt(parts[1]);
      let year = parseInt(parts[2]);
      if (year < 100) year += 2000;
      return new Date(year, month, day);
    }
    
    function formatDateForDisplay(date) {
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      const y = String(date.getFullYear()).slice(-2);
      return `${m}/${d}/${y}`;
    }
    
    function adjustQuantity(delta) {
      const input = document.getElementById('quantity');
      const current = parseInt(input.value) || 0;
      const newVal = Math.max(0, current + delta);
      input.value = newVal || '';
      updateResults();
    }
    
    function adjustStepper(index, field, delta) {
      const current = parseInt(doseData[index][field]) || 0;
      const newVal = Math.max(0, current + delta);
      doseData[index][field] = newVal || '';
      renderLines();
      updateResults();
    }
    
    function renderLines() {
      const container = document.getElementById('doseLines');
      container.innerHTML = doseData.map((line, i) => {
        const total = (parseFloat(line.tabs)||0) * (parseFloat(line.days)||0);
        return `
        <div class="dose-row">
          <div class="stepper">
            <button tabindex="-1" onclick="adjustStepper(${i},'tabs',-1)">âˆ’</button>
            <input type="number" id="tabs${i}" value="${line.tabs}" 
              oninput="updateLine(${i},'tabs',this.value)"
              onkeydown="handleTabsKey(event,${i})"
              placeholder="0">
            <button tabindex="-1" onclick="adjustStepper(${i},'tabs',1)">+</button>
          </div>
          <div class="stepper">
            <button tabindex="-1" onclick="adjustStepper(${i},'days',-1)">âˆ’</button>
            <input type="number" id="days${i}" value="${line.days}" 
              oninput="updateLine(${i},'days',this.value)"
              onkeydown="handleDaysKey(event,${i})"
              placeholder="0">
            <button tabindex="-1" onclick="adjustStepper(${i},'days',1)">+</button>
          </div>
          <div class="total-tabs">${total || 'â€”'}</div>
        </div>
      `}).join('');
    }
    
    function updateLine(i, field, val) {
      doseData[i][field] = val;
      const total = (parseFloat(doseData[i].tabs)||0) * (parseFloat(doseData[i].days)||0);
      document.querySelectorAll('.dose-row')[i].querySelector('.total-tabs').textContent = total || 'â€”';
      updateResults();
    }
    
    function handleTabsKey(e, i) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (doseData[i].tabs === '') return;
        document.getElementById(`days${i}`).focus();
      }
    }
    
    function handleDaysKey(e, i) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (i === doseData.length - 1) addLine();
        setTimeout(() => {
          const nextTabs = document.getElementById(`tabs${i+1}`);
          if (nextTabs) nextTabs.focus();
        }, 10);
      }
    }
    
    function addLine() {
      doseData.push({tabs:'',days:''});
      renderLines();
      setTimeout(() => document.getElementById(`tabs${doseData.length-1}`).focus(), 10);
    }
    
    function getTotal() {
      return doseData.reduce((sum, l) => sum + (parseFloat(l.tabs)||0)*(parseFloat(l.days)||0), 0);
    }
    
    function getTotalDays() {
      return doseData.reduce((sum, l) => sum + (parseFloat(l.days)||0), 0);
    }
    
    function updateResults() {
      const total = getTotal();
      const days = getTotalDays();
      const qty = parseFloat(document.getElementById('quantity').value) || 0;
      const hasQty = document.getElementById('quantity').value !== '';
      const diff = qty - total;
      
      document.getElementById('calendarSection').style.display = total > 0 ? 'block' : 'none';
      
      if (total === 0) {
        document.getElementById('results').innerHTML = '';
        return;
      }
      
      let cls = hasQty ? (diff === 0 ? 'match' : 'mismatch') : 'calculated';
      let status = hasQty ? (diff === 0 ? 'âœ“ Match' : 'âš  Mismatch') : 'ðŸ“Š Calculated';
      let diffText = hasQty && diff !== 0 ? `<div class="diff">${diff>0?'+':''}${diff} ${diff>0?'Extra':'Short'}</div>` : '';
      
      document.getElementById('results').innerHTML = `
        <div class="results-card ${cls}">
          <div class="status">${status}</div>
          <div class="grid">
            <div><div class="val">${hasQty ? qty : total}</div><div class="lbl">Rx</div></div>
            <div><div class="val">${total}</div><div class="lbl">Need</div></div>
            <div><div class="val">${days}</div><div class="lbl">Days</div></div>
          </div>
          ${diffText}
        </div>
      `;
    }
    
    function getCalendarDays() {
      const startStr = document.getElementById('startDate').value;
      const startDate = parseDate(startStr);
      if (!startDate) return [];
      const days = [];
      let date = new Date(startDate);
      doseData.forEach(l => {
        const tabs = parseFloat(l.tabs) || 0;
        const numDays = parseFloat(l.days) || 0;
        for (let i = 0; i < numDays; i++) {
          days.push({date: new Date(date), tabs});
          date.setDate(date.getDate() + 1);
        }
      });
      return days;
    }
    
    function generateCalendar() {
      const days = getCalendarDays();
      if (days.length === 0) return;
      
      const start = formatDateForDisplay(days[0].date);
      const end = formatDateForDisplay(days[days.length-1].date);
      document.getElementById('printSubtitle').textContent = `${start} to ${end} Â· ${getTotalDays()} days Â· ${getTotal()} tablets`;
      
      const months = [];
      let curMonth = null, monthData = null;
      
      days.forEach(day => {
        const key = `${day.date.getFullYear()}-${day.date.getMonth()}`;
        if (key !== curMonth) {
          if (monthData) months.push(monthData);
          curMonth = key;
          const first = new Date(day.date.getFullYear(), day.date.getMonth(), 1);
          const last = new Date(day.date.getFullYear(), day.date.getMonth() + 1, 0);
          monthData = {
            name: day.date.toLocaleString('default',{month:'long'}),
            year: day.date.getFullYear(),
            days: Array(first.getDay()).fill(null)
          };
          for (let d = 1; d <= last.getDate(); d++) monthData.days.push({dayNum:d, tabs:null});
        }
        const idx = monthData.days.findIndex(d => d && d.dayNum === day.date.getDate());
        if (idx !== -1) monthData.days[idx].tabs = day.tabs;
      });
      if (monthData) months.push(monthData);
      
      let html = '';
      months.forEach(m => {
        html += `<div class="month-container"><div class="month-title">${m.name} ${m.year}</div><div class="cal-grid">`;
        weekDays.forEach(d => html += `<div class="cal-header">${d}</div>`);
        m.days.forEach(d => {
          if (d === null) html += '<div class="cal-day empty"></div>';
          else if (d.tabs !== null) html += `<div class="cal-day has-dose"><span class="day-num">${d.dayNum}</span><span class="tabs">${d.tabs}</span></div>`;
          else html += `<div class="cal-day"><span class="day-num">${d.dayNum}</span></div>`;
        });
        html += '</div></div>';
      });
      
      document.getElementById('calendarContent').innerHTML = html;
      document.getElementById('calendarDisplay').style.display = 'block';
      document.getElementById('calendarDisplay').scrollIntoView({behavior: 'smooth'});
    }
    
    function saveAsPDF() {
      const element = document.getElementById('calendarDisplay');
      const toolbar = element.querySelector('.calendar-toolbar');
      toolbar.style.display = 'none';
      document.querySelector('.print-title').style.display = 'block';
      
      const days = getCalendarDays();
      const start = formatDateForDisplay(days[0].date).replace(/\//g, '-');
      const end = days.length > 0 ? formatDateForDisplay(days[days.length-1].date).replace(/\//g, '-') : '';
      
      const opt = {
        margin: [15, 15, 15, 15],
        filename: `Prednisone Schedule ${start} to ${end}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy'], before: '.month-container', avoid: '.instructions' }
      };
      
      html2pdf().set(opt).from(element).save().then(() => {
        toolbar.style.display = 'flex';
        document.querySelector('.print-title').style.display = 'none';
      });
    }
    
    document.getElementById('quantity').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('tabs0').focus();
      }
    });
    document.getElementById('quantity').addEventListener('input', updateResults);
    
    renderLines();
  </script>
</body>
</html>